<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Space Force</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 800,
        physics: {
            default: 'arcade',
            arcade: {
                fps: 60,
                gravity: { y: 0 },
                debug: true,
                debugShowBody: true,
                debugShowAngularVelocity: true,
                debugAngularVelocityColor: 0xffff00,
                debugBodyColor: 0x0000ff
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };
    var cursors; //controls

    var game = new Phaser.Game(config);

    function preload ()
    {
        this.load.image('ship', 'assets/ship2.png');
        this.load.image('asteroid_large', 'assets/asteroid_large.png')
    }

    function create ()
    {
        this.player = createPlayer(this);

        // asteroid = this.physics.add.image(200, 200, 'asteroid_large');
        // asteroid.setMaxVelocity(100);
        // asteroid.setAngularVelocity(10);
        // asteroid.setVelocity(10, 0);
        // asteroid.setBounce(1);
        // asteroid.setCircle(64);

        // asteroid = this.physics.add.group({
        //     defaultKey: 'asteroid_large',
        //     bounceX: 1,
        //     bounceY: 1,
        //     circle: 64,
        //     angularVelocity: 10,
        //     mass: 10
        // });

        // asteroid.defaults.setVelocityX = 100;
        // asteroid.defaults.setVelocityY = 50;
        
        // asteroids = asteroid.createMultiple({
        //     quantity: 3,
        //     key: asteroid.defaultKey,
        //     frame: 0
        // });
        // var PlaceOnCircle = Phaser.Actions.PlaceOnCircle;
        // PlaceOnCircle(asteroids, { x: -200, y: -200, radius: 50 });

        // asteroid.children.each(function (asteroid)
        // {
        //     asteroid.setCircle(64);
        // });
        this.asteroids = this.physics.add.group();

        this.largeAsteroids = [];
        this.mediumAsteroids = [];
        this.smallAsteroids = [];

        //this.asteroids.add(this.largeAsteroids);

        //add colliders
        this.physics.add.collider(this.player, this.asteroids);

        this.asteroidController = new AsteroidController();

        this.cursors = this.input.keyboard.createCursorKeys();
        spawnAsteroidWave(this, 4);
    }

    function update ()
    {       
        input(this);

        this.physics.world.wrap(this.player, 32);
        this.physics.world.wrapArray(this.largeAsteroids, 32);
        this.physics.world.wrapArray(this.mediumAsteroids, 32);
        this.physics.world.wrapArray(this.smallAsteroids, 32);
    }

    function createPlayer(scene) {
        scene.player = scene.physics.add.image(400, 400, 'ship');
        scene.player.setAngle(-90);
        scene.player.setDamping(true);
        scene.player.setDrag(0.99);
        scene.player.setMaxVelocity(200);
        scene.player.setCircle(32);
        scene.player.setMass(50);
        return scene.player;
    }
    function input(scene) {
        // check for forward movement
        if (scene.cursors.up.isDown)
        {
            scene.physics.velocityFromRotation(scene.player.rotation, 200, scene.player.body.acceleration);
        }
        else
        {
            scene.player.setAcceleration(0);
        }
        
        // check for rotation
        if (scene.cursors.left.isDown)
        {
            scene.player.setAngularVelocity(-300);
        }
        else if (scene.cursors.right.isDown)
        {
            scene.player.setAngularVelocity(300);
        }
        else
        {
            scene.player.setAngularVelocity(0);
        }
    }
    function spawnAsteroidWave(scene, level) {
        scene.asteroidController.genAsteroids(scene, level);
    }

    class AsteroidController {
             
        genAsteroids(scene, num) {
            console.log(scene.game.config.width);
            for (let i = 0; i < num; i++) {
                this.spawnAsteroid(scene);
            }
            console.log("spawn asteroids");
        }

        //Deletes all asteroids from the field
        clearAsteroids() {
            for (let i = 0; i < this.asteroids.length; i++) {
            this.asteroids[i].destroy();
            }
        }

        spawnAsteroid(scene) {
            let side = Math.floor(Math.random() * 4);
            //Using the side, generate the x,y values where the asteroid is supposed to spawn
            let spawnLocation = this.genSpawnLocation(
            side,
            scene.game.config.width,
            scene.game.config.height
            );
            //Using the side, generate the direction the asteroid should be moving
            let direction = this.genDirection(side);
            return new LargeAsteroid(scene, spawnLocation.x, spawnLocation.y, direction, Math.floor(Math.random() * 100) + 50);
        }

        genSpawnLocation(side, gameWidth, gameHeight) {
            switch (side) {
            case 2:
                return { x: 0, y: this.randomIntFromInterval(0, gameHeight) };
            case 3:
                return { x: gameWidth, y: this.randomIntFromInterval(0, gameHeight) };
            case 1:
                return { x: this.randomIntFromInterval(0, gameWidth), y: 0 };
            case 0:
                return { x: this.randomIntFromInterval(0, gameWidth), y: gameHeight };
            }
        }

        genDirection(side) {
            //Left side is tricky because it requires a range (in degrees) of
            //Left: 270-360 or 0-90
            switch (side) {
            case 2:
                if (this.randomIntFromInterval(0, 1) === 0) {
                    return this.randomIntFromInterval(280, 350);
                } else {
                    return this.randomIntFromInterval(10, 80);
                }
            case 3:
                return this.randomIntFromInterval(110, 250);
            case 0:
                return this.randomIntFromInterval(200, 340);
            case 1:
                return this.randomIntFromInterval(20, 160);
            }
        }

        randomIntFromInterval(min, max) {
            return Math.floor(Math.random() * (max - min + 1) + min);
        }
    }

    class Asteroid extends Phaser.Physics.Arcade.Sprite {
        constructor(scene, x, y, texture, rotation, speed) {
            super(scene, x, y, texture);
            this.scene = scene;
            scene.add.existing(this);
            scene.asteroids.add(this);

            this.setRotation(rotation);
            scene.physics.world.enableBody(this);
            this.setBounce(1);
            scene.physics.velocityFromAngle(rotation, speed, this.body.velocity);
            console.log("asteroid created");
        }
    }

    class LargeAsteroid extends Asteroid {
        constructor(scene, x, y, rotation, speed) {
            super(scene, x, y, "asteroid_large", rotation, speed);
            this.setCircle(56);
            scene.largeAsteroids.push(this);
        }

        destroyAsteroid() {
            new MediumAsteroid(
            this.scene,
            this.x,
            this.y,
            Math.floor(Math.random() * 360),
            Math.floor(Math.random() * 75) + 50
            );

            new MediumAsteroid(
            this.scene,
            this.x,
            this.y,
            Math.floor(Math.random() * 360),
            Math.floor(Math.random() * 75) + 50
            );

            new MediumAsteroid(
            this.scene,
            this.x,
            this.y,
            Math.floor(Math.random() * 360),
            Math.floor(Math.random() * 75) + 50
            );

            this.destroy();
        }
    }

    class MediumAsteroid extends Asteroid {

    }

    class SmallAsteroid extends Asteroid {
        constructor(scene, x, y, rotation, speed) {
            //Use these to pass these back to the super class to construct the object
            super(scene, x, y, "small_asteroid", rotation, speed);
            this.setSize(12, 12);
            this.setOffset(5, 5);
            scene.smallAsteroids.push(this);
        }

        //Upon destruction, the asteroid deletes itself.
        destroyAsteroid() {
            this.destroy();
        }
    }

</script>

</body>
</html>